<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Drag and Drop with ZIP Download</title>
    <!-- Bootstrap CSS -->
    <link href="bootstrap.min.css" rel="stylesheet" />
    <style>
      .drag-area {
        border: 2px dashed #007bff;
        padding: 20px;
        text-align: center;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .drag-area.dragover {
        background-color: #e9ecef;
      }
      .file-list {
        margin-top: 20px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #007bff;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <label class="switch">
                <input type="checkbox" id="hash-switch" />
                <span class="slider"></span>
              </label>
              <span id="hash-algorithm-label">SHA-1</span>
            </div>
          </div>
          <div id="drag-area" class="drag-area">
            <h4>Drag & Drop your file here</h4>
            <p>or click to select a file</p>
          </div>
          <div class="mt-3">
            <select
              id="file-select"
              class="form-select"
              aria-label="Select a file"
            >
              <option value="">Select a file</option>
            </select>
          </div>
          <div id="file-info" class="file-list mt-3"></div>
          <div id="file-content" class="file-list mt-3"></div>
          <button id="download-zip-button" class="btn btn-success mt-3">
            Download ZIP with All Files
          </button>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <!-- JSZip and jsSHA Libraries -->
    <script src="js/jszip.min.js"></script>
    <script src="js/sha.min.js"></script>
    <script src="js/md5.min.js"></script>
    <!-- HexView JS -->
    <script src="hexview.js"></script>
    <!-- FilesHolder JS -->
    <script src="filesHolder.js"></script>

    <!-- Custom Script -->
    <script>
      const dragArea = document.getElementById("drag-area");
      const fileSelect = document.getElementById("file-select");
      const fileInfo = document.getElementById("file-info");
      const fileContent = document.getElementById("file-content");
      const hashAlgorithmLabel = document.getElementById(
        "hash-algorithm-label"
      );
      const hashSwitch = document.getElementById("hash-switch");
      const filesHolder = new FilesHolder();

      hashSwitch.addEventListener("change", async () => {
        const algorithm = hashSwitch.checked ? "MD5" : "SHA-1";
        filesHolder.setHashAlgorithm(algorithm);
        hashAlgorithmLabel.textContent = algorithm;
        await filesHolder.recalculateAllHashes(); // Recalculate all hashes based on the new algorithm
        displayFileInfo(fileSelect.value); // Update displayed hash for the selected file
      });

      dragArea.addEventListener("dragover", (event) => {
        event.preventDefault();
        dragArea.classList.add("dragover");
      });

      dragArea.addEventListener("dragleave", () => {
        dragArea.classList.remove("dragover");
      });

      dragArea.addEventListener("drop", async (event) => {
        event.preventDefault();
        dragArea.classList.remove("dragover");
        const files = event.dataTransfer.files;
        try {
          for (let file of files) {
            await filesHolder.addFile(file);
          }
          updateFileSelect();
          // Automatically select the first file
          if (fileSelect.options.length > 1) {
            fileSelect.value = fileSelect.options[1].value;
            displayFileInfo(fileSelect.value);
          }
        } catch (error) {
          console.error("Error during file drop:", error);
        }
      });

      dragArea.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.multiple = true;
        input.onchange = async () => {
          const files = input.files;
          try {
            for (let file of files) {
              await filesHolder.addFile(file);
            }
            updateFileSelect();
            // Automatically select the first file
            if (fileSelect.options.length > 1) {
              fileSelect.value = fileSelect.options[1].value;
              displayFileInfo(fileSelect.value);
            }
          } catch (error) {
            console.error("Error selecting files:", error);
          }
        };
        input.click();
      });

      fileSelect.addEventListener("change", () => {
        displayFileInfo(fileSelect.value);
      });

      function updateFileSelect() {
        const fileNames = filesHolder.getFileNames();
        fileSelect.innerHTML = `<option value="">Select a file</option>`;
        fileNames.forEach((fileName) => {
          const option = document.createElement("option");
          option.value = fileName;
          option.textContent = fileName;
          fileSelect.appendChild(option);
        });
      }

      function displayFileInfo(fileName) {
        fileInfo.innerHTML = ""; // Clear previous info
        fileContent.innerHTML = ""; // Clear previous content
        if (!fileName) return;

        const file = filesHolder.getFile(fileName);
        if (!file) return;

        const fileDetails = `
          <div class="card mb-2">
              <div class="card-body">
                  <h5 class="card-title">${file.name}</h5>
                  <p class="card-text"><strong>Size:</strong> ${
                    file.size
                  } bytes</p>
                  <p class="card-text"><strong>Original ${
                    filesHolder.hashAlgorithm
                  }:</strong> ${file.originalHash}</p>
                  <p class="card-text"><strong>Editable ${
                    filesHolder.hashAlgorithm
                  }:</strong> ${file.editableHash}</p>
                  ${
                    file.zipFileName
                      ? `<p class="card-text"><strong>Contained in ZIP:</strong> ${file.zipFileName}</p>`
                      : ""
                  }
              </div>
          </div>
      `;

        fileInfo.innerHTML = fileDetails;

        // Display the file content as a hex dump using hexview function
        const hexDump = hexview(Array.from(file.originalData), 0x0, "html");
        fileContent.innerHTML = hexDump;
      }

      document
        .getElementById("download-zip-button")
        .addEventListener("click", async () => {
          try {
            const zipBlob = await filesHolder.generateZipFile();
            const zipFileName = filesHolder.getZipFileName(); // Get the zip file name

            const link = document.createElement("a");
            link.href = URL.createObjectURL(zipBlob);
            link.download = zipFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            console.error("Error downloading ZIP file:", error);
          }
        });
    </script>
  </body>
</html>
