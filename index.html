<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Drag and Drop with ZIP Download</title>
    <!-- Tailwind CSS CDN -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link href="./css/tailwind.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-100 min-w-[375px] w-full">
    <!--  -->
    <!-- Container to hold both divs in a flex layout with the new xs breakpoint -->
    <div class="flex items-start gap-2 my-1 flex-row w-full">
      <!-- --------------- Title and SHA-1/MD5 toggle switch --------------- -->
      <div w-[200px]>
        <!-- --------------- Title --------------- -->
        <h1 class="text-3xl font-bold text-left pl-2 text-gray-700">
          ROMedit v.2
        </h1>

        <small class="block text-10px] text-left pl-2 text-gray-700 mb-0"
          >by FedeKrum</small
        >
        <!-- --------------- Switch --------------- -->
        <div class="flex-shrink-0 min-w-[178px] w-14 self-start">
          <div
            class="shadow rounded-full border h-10 flex p-1 relative items-center bg-blue-400 text-white"
          >
            <span class="w-full flex justify-center">MD5</span>
            <span class="w-full flex justify-center">SHA-1</span>
            <button
              class="elSwitch bg-white shadow text-gray-800 flex items-center justify-center w-1/2 rounded-full h-8 transition-all top-[px] absolute left-1"
            >
              Hashing
            </button>
          </div>
        </div>
      </div>
      <!-- --------------- Drag-and-drop area for files --------------- -->
      <div
        id="drag-area"
        class="border-4 border-blue-500 border-dashed p-5 text-center rounded-md bg-gray-50 hover:bg-gray-200 transition w-full"
      >
        <h4 class="text-lg font-semibold text-gray-700">Drag & Drop files</h4>
        <p class="text-sm text-gray-500">or click to browse</p>
      </div>
    </div>

    <!-- --------------- Dropdown menu for selecting a file --------------- -->
    <div class="flex-grow w-auto">
      <select
        id="file-select"
        class="block w-full p-2 border border-gray-300 rounded font-mono"
        aria-label="Select a file"
      >
        <option value="">Select a file</option>
      </select>
    </div>

    <!-- --------------- File information --------------- -->
    <div id="file-info" class="mt-3 font-mono text-base"></div>
    <!-- --------------- Editor --------------- -->
    <div id="offset-group" class="mt-4">
      <label for="offset" class="block text-sm text-gray-700 mb-1">
        <p class="block">
          Offset: (in hex notation) | current decimal value:
          <span id="offsetDEC"></span>
        </p>
      </label>
      <input
        type="text"
        class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        id="offset"
        name="offset"
        value="0"
      />
    </div>

    <div id="csv" class="mt-4">
      <label for="values" class="block text-sm text-gray-700 mb-1">
        <p class="block">
          Values: (address, byte : both in hex notation) | changes:
          <span id="changes"></span>
        </p>
      </label>

      <div class="flex flex-row">
        <div class="">
          <textarea
            id="valuesStatus"
            name="valuesStatus"
            class="w-full max-w-32 p-2 border border-gray-300 rounded font-mono bg-gray-100 resize-none"
            rows="5"
            readonly
          >
1 âœ…
2 ðŸš«R
3 ðŸš«S
4 âœ…
5 âœ…
6 âœ…
7 
        </textarea
          >
        </div>
        <div class="">
          <textarea
            id="values"
            name="values"
            class="w-full p-2 border border-gray-300 rounded font-mono resize-none"
            rows="5"
          >
0,1
90,3
esdfsdfs
2,3
3,4
4,5
          </textarea>
        </div>
      </div>

      <small class="block mt-2 text-gray-600">
        âœ… Ok&nbsp;&nbsp;&nbsp;ðŸš«<strong>R</strong> No change. Out of
        range&nbsp;&nbsp;&nbsp;ðŸš«<strong>S</strong> No change. Syntax error
      </small>
    </div>

    <!-- --------------- Download button --------------- -->
    <button
      id="download-button"
      class="w-full mt-3 py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 transition"
    >
      Download ZIP with All Files
    </button>
    <!-- --------------- HEX dump content --------------- -->
    <div data-collapsible="HEX dump" collapsible-not-collapsed>
      <div
        id="file-content"
        class="bg-orange-200 m-[1px] font-mono text-dynamic"
      ></div>
    </div>

    <!-- -------------------------------------------------------------- -->
    <!--                           JS Files                             -->
    <!-- -------------------------------------------------------------- -->
    <script src="js/jszip.min.js"></script>
    <script src="js/sha.min.js"></script>
    <script src="js/md5.min.js"></script>

    <!-- HexView JS for displaying hex dump of file content -->
    <script src="hexview.js"></script>

    <!-- FilesHolder JS for managing file operations -->
    <script src="filesHolder.js"></script>

    <script>
      // DOM elements for interaction
      const dragArea = document.getElementById("drag-area");
      const fileSelect = document.getElementById("file-select");
      const fileInfo = document.getElementById("file-info");
      const fileContent = document.getElementById("file-content");

      // Instance of FilesHolder class to manage files and hashing
      const filesHolder = new FilesHolder();

      // Event listener to toggle between SHA-1 and MD5 hash algorithms

      const elSwitchs = document.querySelectorAll(".elSwitch");
      elSwitchs.forEach((e) => {
        var algorithm;
        e.addEventListener("click", function () {
          if (e.classList.contains("left-[84px]")) {
            e.classList.remove("left-[84px]");
            e.classList.add("left-1");
            console.log("SHA-1");
            algorithm = "SHA-1";
          } else {
            e.classList.remove("left-1");
            e.classList.add("left-[84px]");
            console.log("MD5");
            algorithm = "MD5";
          }
          filesHolder.setHashAlgorithm(algorithm);
          filesHolder.recalculateAllHashes(); // Recalculate hashes based on selected algorithm
          displayFileInfo(fileSelect.value); // Update displayed file info
        });
      });

      // Event listener to handle drag-and-drop of files
      dragArea.addEventListener("dragover", (event) => {
        event.preventDefault();
        dragArea.classList.add("bg-gray-200");
      });

      // Remove dragover styling when the file is no longer dragged over the area
      dragArea.addEventListener("dragleave", () => {
        dragArea.classList.remove("bg-gray-200");
      });

      // Handle files dropped onto the drag area
      dragArea.addEventListener("drop", async (event) => {
        event.preventDefault();
        dragArea.classList.remove("bg-gray-200");
        const files = event.dataTransfer.files;
        try {
          for (let file of files) {
            await filesHolder.addFile(file); // Add each dropped file to the FilesHolder
          }
          updateFileSelect(); // Update the file selection dropdown
          // Automatically select and display the first file in the list
          if (fileSelect.options.length > 1) {
            fileSelect.value = fileSelect.options[1].value;
            displayFileInfo(fileSelect.value);
          }
        } catch (error) {
          console.error("Error during file drop:", error);
        }
      });

      // Handle click on the drag area to trigger file input dialog
      dragArea.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.multiple = true;
        input.onchange = async () => {
          const files = input.files;
          try {
            for (let file of files) {
              await filesHolder.addFile(file); // Add selected files to the FilesHolder
            }
            updateFileSelect(); // Update the file selection dropdown
            // Automatically select and display the first file in the list
            if (fileSelect.options.length > 1) {
              fileSelect.value = fileSelect.options[1].value;
              displayFileInfo(fileSelect.value);
            }
          } catch (error) {
            console.error("Error selecting files:", error);
          }
        };
        input.click(); // Simulate click on hidden file input
      });

      // Event listener to display information when a file is selected from the dropdown
      fileSelect.addEventListener("change", () => {
        displayFileInfo(fileSelect.value);
      });

      // Function to update the file hash and display updated info
      async function updateFileHash(fileName) {
        try {
          await filesHolder.updateEditableHash(fileName);
          displayFileInfo(fileName);
        } catch (error) {
          console.error(
            `Error updating file ${filesHolder.hashAlgorithm} hash:`,
            error
          );
        }
      }

      // Function to update the file selection dropdown with the list of uploaded files
      function updateFileSelect() {
        const fileNames = filesHolder.getFileNames();
        fileSelect.innerHTML = `<option value="">Select a file</option>`;
        fileNames.forEach((fileName) => {
          const option = document.createElement("option");
          option.value = fileName;
          option.textContent = fileName;
          fileSelect.appendChild(option);
        });
      }

      // Function to display the selected file's information and content
      function displayFileInfo(fileName) {
        fileInfo.innerHTML = ""; // Clear previous info
        console.log(fileContent.innerHTML);
        fileContent.innerHTML = ""; // Clear previous content
        console.log(fileContent.innerHTML);
        if (!fileName) return;

        const file = filesHolder.getFile(fileName);
        if (!file) return;

        const fileDetails = `
          <div class="bg-white shadow rounded-lg p-2  font-mono">
              <p class="text-sm"><strong>SRC ${
                filesHolder.hashAlgorithm
              }:</strong> ${file.originalHash}</p>
              <p class="text-sm"><strong>OUT ${
                filesHolder.hashAlgorithm
              }:</strong> ${file.editableHash}</p>

              <p class="text-sm"><strong>Size:</strong> ${file.size} bytes
              ${
                file.zipFileName
                  ? ` | <strong>From:</strong> ${file.zipFileName}</p>`
                  : ""
              }
          </div>
      `;

        fileInfo.innerHTML = fileDetails;

        // Display the file content as a hex dump using hexview function
        const hexDump = hexview(Array.from(file.originalData), 0x0, "html");
        fileContent.innerHTML = hexDump;
      }

      // Event listener to download all files as a ZIP archive
      document
        .getElementById("download-button")
        .addEventListener("click", async () => {
          try {
            const zipBlob = await filesHolder.generateZipFile();
            const zipFileName = filesHolder.getZipFileName(); // Get the zip file name

            const link = document.createElement("a");
            link.href = URL.createObjectURL(zipBlob);
            link.download = zipFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            console.error("Error downloading ZIP file:", error);
          }
        });
    </script>
  </body>
</html>
